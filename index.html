<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simulador UTEG ¬∑ Solo dictado (IA cliente)</title>
<style>
  :root{--brand:#003C71;--accent:#00A3AD;--ink:#111827;--muted:#6b7280;--bg:#f6f7fb;--card:#fff;--ring:rgba(0,60,113,.18)}
  *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:980px;margin:20px auto;padding:16px}
  h1{font-size:22px;margin:0 0 12px}
  .grid{display:grid;grid-template-columns:340px 1fr;gap:16px}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
  .panel{background:var(--card);border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 4px 20px rgba(0,0,0,.05)}
  .panel .hd{padding:12px;border-bottom:1px solid #eef1f5;font-weight:700}
  .panel .bd{padding:12px}
  .row{display:grid;gap:6px;margin-bottom:10px}
  label{font-size:12px;color:var(--muted)}
  select,textarea,input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #d1d5db;background:#fff}
  select:focus,textarea:focus,input:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 4px var(--ring)}
  .actions{display:flex;gap:10px;flex-wrap:wrap}
  button{cursor:pointer;border:1px solid var(--brand);background:var(--brand);color:#fff;border-radius:10px;padding:10px 14px;font-weight:700}
  button.ghost{background:#fff;color:var(--brand)}
  .btn-accent{background:#00A3AD;border-color:#00A3AD}
  .chat{display:flex;flex-direction:column;height:620px}
  .log{flex:1;overflow:auto;padding:12px;background:linear-gradient(#fff,#fafbff)}
  .msg{display:flex;gap:8px;margin-bottom:10px}
  .bubble{max-width:78%;padding:10px 12px;border-radius:12px;line-height:1.35;border:1px solid #e5e7eb;background:#fff;font-size:14px}
  .you .bubble{background:#eef4ff;border-color:#d7e5ff}
  .ai .bubble{background:#eefaf7;border-color:#cdeee2}
  .avatar{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;font-size:12px}
  .avatar.ai{background:var(--brand)} .avatar.you{background:#6b21a8}
  .composer{border-top:1px solid #eef1f5;padding:10px;background:#fff;border-bottom-left-radius:14px;border-bottom-right-radius:14px}
  .composer form{display:flex;gap:8px;align-items:flex-end}
  .composer textarea{flex:1;min-height:120px;resize:vertical}
  .row-inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef2ff;border:1px solid #e0e7ff;font-size:11px}
  .hint{font-size:12px;color:#6b7280}
  .box{border:1px dashed #d1d5db;border-radius:10px;padding:8px;background:#fafbff}
  .bad{background:#fff0f0;border-color:#ffd6d6}
  .ok{background:#ecfdf5;border-color:#bbf7d0}
</style>
</head>
<body>
<div class="wrap">
  <h1>Simulador de llamada ¬∑ UTEG (solo dictado)</h1>
  <div class="grid">
    <!-- Controles -->
    <div class="panel">
      <div class="hd">Controles</div>
      <div class="bd">
        <div class="row">
          <label>Escenario</label>
          <select id="scenario">
            <option value="Licenciatura Semestral UdeG">Licenciatura Semestral UdeG</option>
            <option value="Licenciatura Cuatrimestral (CEP/SEP)">Licenciatura Cuatrimestral (CEP/SEP)</option>
            <option value="Bachillerato Intensivo (BIS)">Bachillerato Intensivo (BIS)</option>
            <option value="Bachillerato General (BGC)">Bachillerato General (BGC)</option>
          </select>
        </div>

        <div class="row actions">
          <button id="start" class="btn-accent" type="button" onclick="window._startSim && window._startSim()">‚ñ∂Ô∏è Iniciar conversaci√≥n</button>
          <button id="reset" class="ghost" type="button">Reiniciar</button>
        </div>

        <hr style="border:none;border-top:1px solid #eef1f5;margin:10px 0">

        <div class="row">
          <label>Estado de permisos</label>
          <div class="row-inline">
            <span id="permState" class="pill">Micr√≥fono: desconocido</span>
            <button id="askPerm" class="ghost" type="button">üîê Solicitar permiso</button>
            <button id="closeMic" class="ghost" type="button" disabled>‚úñÔ∏è Cerrar micr√≥fono</button>
          </div>
          <div class="hint">En la barra de direcciones ‚Üí candado ‚Üí Permisos ‚Üí Micr√≥fono: <b>Permitir</b>.</div>
        </div>

        <div class="row">
          <label>Dictado (transcribir a texto en vivo)</label>
          <div class="row-inline">
            <button id="dictBtn" class="ghost" type="button">üó£Ô∏è Iniciar dictado</button>
            <label class="hint"><input type="checkbox" id="autoRestart" checked> Reintentar autom√°ticamente</label>
            <span id="sttStatus" class="pill">Dictado: inactivo</span>
          </div>
          <div id="liveBox" class="box hint">Aqu√≠ ver√°s la transcripci√≥n en vivo‚Ä¶</div>
          <div class="hint bad" id="warnBox" style="display:none">Permiso denegado. Cambia a ‚ÄúPermitir‚Äù en el candado del navegador y recarga.</div>
        </div>
      </div>
    </div>

    <!-- Chat -->
    <div class="panel chat">
      <div class="hd">Conversaci√≥n</div>
      <div id="log" class="log"></div>
      <div class="composer">
        <form id="form">
          <textarea id="input" placeholder="Escribe o usa el dictado para pegar aqu√≠ tu respuesta‚Ä¶" disabled></textarea>
          <button id="send" type="submit" disabled>Enviar</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  /* ===== Utilidades ===== */
  function norm(t){return (t||'').toLowerCase().normalize('NFD').replace(/\\p{Diacritic}/gu,'').replace(/\\s+/g,' ').trim();}
  function any(text, arr){ text=norm(text); return arr.some(k=> text.includes(norm(k))); }
  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
  function speak(text){
    if(!('speechSynthesis' in window)) return;
    const u=new SpeechSynthesisUtterance(text);
    u.lang='es-MX';
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
  }

  /* ===== Conversaci√≥n con cliente "inteligente" ===== */
  const logEl = document.getElementById("log");
  const inputEl = document.getElementById("input");
  const sendBtn = document.getElementById("send");
  const startBtn = document.getElementById("start");
  const resetBtn = document.getElementById("reset");
  const scenarioSel = document.getElementById("scenario");

  const state = {
    phase: 'sondeo',
    scenario: 'Licenciatura Semestral UdeG',
    asked: { ocup:false, factor:false, comparo:false, inicio:false },
    objectionsUsed: false,
    turns: 0
  };

  function addMsg(who, html){
    const row=document.createElement("div"); row.className=`msg ${who}`;
    const av=document.createElement("div"); av.className=`avatar ${who}`; av.textContent=who==='you'?'A':'CL';
    const b=document.createElement("div"); b.className='bubble'; b.innerHTML=html; row.append(av,b);
    logEl.append(row); logEl.scrollTop=logEl.scrollHeight;
    if(who==='ai') speak(b.textContent);
  }
  function enableInput(on){ inputEl.disabled=!on; sendBtn.disabled=!on; if(on) inputEl.focus(); }

  function startSim(){
    logEl.innerHTML='';
    state.phase='sondeo'; state.asked={ocup:false,factor:false,comparo:false,inicio:false}; state.objectionsUsed=false; state.turns=0;
    state.scenario = scenarioSel.value;
    addMsg('ai', `Hola, busco informes sobre <b>${state.scenario}</b>. ¬øMe ayudas?`);
    enableInput(true);
  }
  window._startSim = startSim;
  startBtn.addEventListener('click', startSim);
  resetBtn.addEventListener('click', ()=>location.reload());

  document.getElementById('form').addEventListener('submit', (e)=>{
    e.preventDefault();
    const t = inputEl.value.trim(); if(!t) return;
    addMsg('you', t);
    inputEl.value = '';
    respondSmart(t);
  });

  const K = {
    ocup: ["trabajo","trabajo actualmente","empleo","empleas","ocupacion","a que te dedicas"],
    factor: ["costo","economico","horario","plan de estudios","materias","proyeccion","bolsa de trabajo","beneficios","beca"],
    comparo: ["otra universidad","otras opciones","comparando","comparado"],
    inicio: ["iniciar","cuando inicio","cuanto antes","este ciclo","proximo ingreso","fecha de inicio"],
    programa: ["licenciatura","bachillerato","semestral","cuatrimestral","intensivo","udeg","sep"],
    costos: ["inscripcion","colegiatura","mensualidad","pagos","costo"],
    becas: ["beca","descuento","apoyo","convocatoria"],
    instalaciones: ["instalaciones","laboratorios","taller","biblioteca","estacionamiento"],
    cierre: ["inscripcion","agendar","cita","visita","proxima llamada","enviar informacion"]
  };

  function respondSmart(user){
    const t = norm(user);
    state.turns++;

    if(K.ocup.some(k=>t.includes(k))) state.asked.ocup = true;
    if(K.factor.some(k=>t.includes(k))) state.asked.factor = true;
    if(K.comparo.some(k=>t.includes(k))) state.asked.comparo = true;
    if(K.inicio.some(k=>t.includes(k))) state.asked.inicio = true;

    if(state.phase === 'sondeo'){
      if(!state.asked.ocup) return addMsg('ai', pick([
        "Para entenderte mejor, ¬øactualmente trabajas o en qu√© te desempe√±as?",
        "¬øEst√°s laborando ahora? ¬øC√≥mo es tu horario?"
      ]));
      if(!state.asked.factor) return addMsg('ai', pick([
        "¬øQu√© te importa m√°s para decidir: costo, horario, plan de estudios o empleabilidad?",
        "Si tuvieras que elegir un factor clave, ¬øcu√°l ser√≠a?"
      ]));
      if(!state.asked.comparo) return addMsg('ai', pick([
        "¬øEst√°s comparando con alguna otra universidad u opci√≥n?",
        "¬øHas visto otras alternativas adem√°s de UTEG?"
      ]));
      if(!state.asked.inicio) return addMsg('ai', pick([
        "¬øPara cu√°ndo te gustar√≠a iniciar si todo encaja?",
        "¬øPlaneas comenzar en el pr√≥ximo ingreso?"
      ]));
      state.phase = 'propuesta';
      return addMsg('ai', pick([
        "Gracias por el contexto. ¬øPodr√≠as explicarme brevemente el plan y c√≥mo est√° organizado?",
        "Perfecto. ¬øC√≥mo est√° estructurado el programa y qu√© ventajas principales tiene?"
      ]));
    }

    if(state.phase === 'propuesta'){
      const mencionoPrograma = K.programa.some(k=>t.includes(k));
      const mencionoInst = K.instalaciones.some(k=>t.includes(k));
      if(!mencionoPrograma){
        return addMsg('ai', pick([
          "¬øMe confirmas el tipo de programa y la modalidad (semestral, cuatrimestral, intensivo)?",
          "¬øEl programa est√° incorporado (UdeG/SEP) y c√≥mo se organiza el avance?"
        ]));
      }
      if(!mencionoInst){
        return addMsg('ai', pick([
          "¬øQu√© tal las instalaciones y apoyos acad√©micos?",
          "¬øCuentan con laboratorios, biblioteca o alg√∫n espacio especializado?"
        ]));
      }
      state.phase = 'inversion';
      return addMsg('ai', pick([
        "Gracias. ¬øC√≥mo est√° el tema de inversi√≥n: inscripci√≥n, colegiaturas y si hay apoyos?",
        "Ok. ¬øMe platicas de costos y opciones de apoyo (beca/desc)?"
      ]));
    }

    if(state.phase === 'inversion'){
      const mencionoCostos = K.costos.some(k=>t.includes(k));
      const mencionoBecas = K.becas.some(k=>t.includes(k));
      if(!mencionoCostos){
        return addMsg('ai', pick([
          "¬øCu√°l ser√≠a la inscripci√≥n y el esquema de colegiaturas?",
          "¬øC√≥mo se pagan las colegiaturas (mensualidades, opciones de pronto pago)?"
        ]));
      }
      if(!mencionoBecas){
        return addMsg('ai', pick([
          "¬øManejan becas o alg√∫n apoyo econ√≥mico?",
          "¬øHay descuentos o convocatorias de beca?"
        ]));
      }
      if(!state.objectionsUsed && Math.random() < 0.35){
        state.phase = 'objecion';
        const kind = pick(['costo','instalaciones','competencia','indecision']);
        state.objectionsUsed = true;
        if(kind==='costo')   return addMsg('ai',"Me preocupa un poco el costo total, sinceramente.");
        if(kind==='instalaciones') return addMsg('ai',"Tengo dudas sobre las instalaciones, ¬øs√≠ est√°n a la altura?");
        if(kind==='competencia')   return addMsg('ai',"Estoy comparando con otra universidad y no estoy seguro.");
        return addMsg('ai',"Sigo indeciso, no estoy al 100% para inscribirme.");
      }
      state.phase = 'cierre';
      return addMsg('ai', pick([
        "Con lo que me explicaste, ¬øcu√°l ser√≠a el siguiente paso para avanzar?",
        "Creo que ya tengo una buena idea; ¬øqu√© seguir√≠a a partir de aqu√≠?"
      ]));
    }

    if(state.phase === 'objecion'){
      state.phase = 'cierre';
      return addMsg('ai', pick([
        "Gracias por aclararlo. ¬øC√≥mo podemos continuar el proceso?",
        "Bien, ¬øqu√© paso sugieres para seguir avanzando?"
      ]));
    }

    if(state.phase === 'cierre'){
      const proponeCierre = K.cierre.some(k=>t.includes(k));
      if(proponeCierre){
        const confirma = Math.random() < 0.5;
        if(confirma){
          const pideRef = Math.random() < 0.6;
          if(pideRef){
            state.phase = 'referidos';
            return addMsg('ai', "Me inscribo. Por cierto, tengo algunos conocidos que podr√≠an estar interesados.");
          }
          addMsg('ai', "Perfecto, procedamos entonces.");
          enableInput(false);
          return;
        }else{
          state.phase = 'referidos';
          return addMsg('ai', "A√∫n no confirmo. ¬øTe comparto datos de alguien m√°s a quien le pueda servir?");
        }
      }
      return addMsg('ai', pick([
        "Si te parece, ¬øagendamos una cita o me compartes c√≥mo iniciar la inscripci√≥n digital?",
        "¬øTe parece si definimos una fecha para el siguiente paso?"
      ]));
    }

    if(state.phase === 'referidos'){
      addMsg('ai', pick([
        "Gracias, con eso ser√≠a todo de mi lado.",
        "Perfecto, qued√≥ claro. ¬°Gracias!"
      ]));
      enableInput(false);
      return;
    }
    addMsg('ai', "Entendido.");
  }

  /* ===== Permisos micr√≥fono (solo para dictado) ===== */
  const permState = document.getElementById('permState');
  const askPermBtn = document.getElementById('askPerm');
  const closeMicBtn = document.getElementById('closeMic');
  const warnBox = document.getElementById('warnBox');

  let micStream = null;
  let micLock = false;
  let permDenied = false;
  let lastPermState = 'unknown';

  function updatePermBadge(state) {
    lastPermState = state;
    permState.textContent = 'Micr√≥fono: ' + state;
    permState.classList.remove('ok','bad');
    if (state === 'granted') permState.classList.add('ok');
    if (state === 'denied')  permState.classList.add('bad');
  }

  async function checkPermission() {
    try {
      if (!navigator.permissions) { updatePermBadge('desconocido'); return 'unknown'; }
      const q = await navigator.permissions.query({ name: 'microphone' });
      updatePermBadge(q.state);
      q.onchange = () => updatePermBadge(q.state);
      return q.state;
    } catch {
      updatePermBadge('desconocido');
      return 'unknown';
    }
  }

  async function ensureMicOnce() {
    if (permDenied) { warnBox.style.display = 'block'; throw new Error('Permission previously denied'); }
    if (micStream) return micStream;
    if (micLock) throw new Error('Mic request in progress');
    micLock = true;
    try {
      const s = await navigator.mediaDevices.getUserMedia({ audio: true });
      micStream = s;
      closeMicBtn.disabled = false;
      warnBox.style.display = 'none';
      updatePermBadge('granted');
      return s;
    } catch (err) {
      if (err && (err.name === 'NotAllowedError' || err.name === 'SecurityError')) {
        permDenied = true;
        warnBox.style.display = 'block';
        updatePermBadge('denied');
      }
      throw err;
    } finally {
      micLock = false;
    }
  }

  function closeMic() {
    if (micStream) { micStream.getTracks().forEach(t=>t.stop()); micStream=null; }
    closeMicBtn.disabled = true;
  }

  askPermBtn?.addEventListener('click', async () => {
    try { await ensureMicOnce(); } catch(e) {}
  });
  closeMicBtn?.addEventListener('click', () => { closeMic(); });

  checkPermission();

  /* ===== Dictado (Web Speech API) sin repeticiones ===== */
  const dictBtn = document.getElementById('dictBtn');
  const autoRestart = document.getElementById('autoRestart');
  const sttStatus = document.getElementById('sttStatus');
  const liveBox = document.getElementById('liveBox');

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition || null;
  let stt=null, sttOn=false, sttWantsOn=false;
  let finalTranscript = "";      // solo frases confirmadas (isFinal)
  let interimTranscript = "";    // provisional
  let lastResultIndex = 0;       // evita reprocesar

  function initStt(){
    if(!SpeechRecognition){ alert('Tu navegador no soporta dictado (Web Speech API). Recomendado: Chrome/Edge en escritorio.'); return null; }
    const r=new SpeechRecognition(); r.lang='es-MX'; r.interimResults=true; r.continuous=true;

    r.onstart=()=>{ sttOn=true; sttStatus.textContent='Dictado: activo'; dictBtn.textContent='‚ñ† Detener dictado'; };

    r.onresult=(ev)=>{
      interimTranscript = "";
      for(let i=lastResultIndex; i<ev.results.length; i++){
        const res = ev.results[i];
        const txt = res[0].transcript.trim();
        if(res.isFinal){
          finalTranscript = (finalTranscript + " " + txt).replace(/\\s+/g," ").trim();
          lastResultIndex = i + 1;
        }else{
          interimTranscript = (interimTranscript + " " + txt).replace(/\\s+/g," ").trim();
        }
      }
      const full = (finalTranscript + " " + interimTranscript).replace(/\\s+/g," ").trim();
      liveBox.textContent = full || "‚Ä¶";
      // No enviamos autom√°ticamente; el asesor decide cu√°ndo enviar
      inputEl.value = full;
    };

    r.onerror=(e)=>{
      sttOn=false; sttStatus.textContent='Dictado: error ('+e.error+')';
      if (e.error === 'not-allowed' || permDenied || lastPermState === 'denied') { sttWantsOn=false; return; }
      if (sttWantsOn && autoRestart.checked) { try{ r.start(); }catch(_){} }
    };

    r.onend=()=>{
      sttOn=false; sttStatus.textContent='Dictado: inactivo';
      lastResultIndex = 0;
      if (permDenied || lastPermState === 'denied') { sttWantsOn=false; return; }
      if (sttWantsOn && autoRestart.checked) { try{ r.start(); }catch(_){} }
    };
    return r;
  }

  dictBtn.addEventListener('click', async ()=>{
    try{ await ensureMicOnce(); }catch(e){ /* si neg√≥, ya mostramos arriba */ }
    if (permDenied || lastPermState === 'denied') { sttStatus.textContent='Dictado: permiso denegado'; return; }

    if(!stt){ stt = initStt(); if(!stt) return; }
    if(!sttWantsOn){
      sttWantsOn = true;
      finalTranscript = ""; interimTranscript = ""; lastResultIndex = 0; liveBox.textContent = "(escuchando‚Ä¶)";
      try{ if(!sttOn) stt.start(); }catch(_){} 
      enableInput(true); // por si no le hab√≠an dado iniciar a√∫n
    }else{
      sttWantsOn = false;
      try{ if(sttOn) stt.stop(); }catch(_){} 
      sttStatus.textContent='Dictado: inactivo'; dictBtn.textContent='üó£Ô∏è Iniciar dictado';
    }
  });
});
</script>
</body>
</html>
