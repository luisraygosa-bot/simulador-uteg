<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simulador UTEG ¬∑ IA con Memoria (Index)</title>
<style>
  :root{--brand:#003C71;--accent:#00A3AD;--ink:#1f2937;--muted:#6b7280;--bg:#f6f7fb;--card:#fff;--ring:rgba(0,60,113,.18)}
  *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1080px;margin:20px auto;padding:16px}
  h1{font-size:22px;margin:0 0 12px}
  .grid{display:grid;grid-template-columns:360px 1fr;gap:16px}
  @media (max-width:950px){.grid{grid-template-columns:1fr}}
  .panel{background:var(--card);border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 4px 20px rgba(0,0,0,.05)}
  .panel .hd{padding:12px;border-bottom:1px solid #eef1f5;font-weight:700}
  .panel .bd{padding:12px}
  .row{display:grid;gap:6px;margin-bottom:10px}
  label{font-size:12px;color:var(--muted)}
  select,textarea,input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #d1d5db;background:#fff}
  select:focus,textarea:focus,input:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 4px var(--ring)}
  .actions{display:flex;gap:10px;flex-wrap:wrap}
  button{cursor:pointer;border:1px solid var(--brand);background:var(--brand);color:#fff;border-radius:10px;padding:10px 14px;font-weight:700}
  button.ghost{background:#fff;color:var(--brand)}
  .btn-accent{background:#00A3AD;border-color:#00A3AD}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef2ff;border:1px solid #e0e7ff;font-size:11px}
  .hint{font-size:12px;color:#6b7280}
  .box{border:1px dashed #d1d5db;border-radius:10px;padding:8px;background:#fafbff}
  .bad{background:#fff0f0;border-color:#ffd6d6}
  .ok{background:#ecfdf5;border-color:#bbf7d0}
  .small{font-size:12px}
  /* Chat */
  .chat{display:flex;flex-direction:column;height:680px}
  .log{flex:1;overflow:auto;padding:12px;background:linear-gradient(#fff,#fafbff)}
  .msg{display:flex;gap:8px;margin-bottom:10px}
  .bubble{max-width:78%;padding:10px 12px;border-radius:12px;line-height:1.35;border:1px solid #e5e7eb;background:#fff;font-size:14px}
  .you .bubble{background:#eef4ff;border-color:#d7e5ff}
  .ai .bubble{background:#eefaf7;border-color:#cdeee2}
  .avatar{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;font-size:12px}
  .avatar.ai{background:var(--brand)} .avatar.you{background:#6b21a8}
  .composer{border-top:1px solid #eef1f5;padding:10px;background:#fff;border-bottom-left-radius:14px;border-bottom-right-radius:14px}
  .composer form{display:flex;gap:8px;align-items:flex-end}
  .composer textarea{flex:1;min-height:120px;resize:vertical}
  .row-inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .audio-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:6px}
  audio{max-width:420px;width:100%}
  .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:6px;padding:0 6px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Simulador de llamada ¬∑ UTEG (IA con memoria)</h1>
  <div class="grid">
    <!-- Controles -->
    <div class="panel">
      <div class="hd">Controles</div>
      <div class="bd">
        <div class="row">
          <label>Escenario</label>
          <select id="scenario">
            <option value="Licenciatura Semestral UdeG">Licenciatura Semestral UdeG</option>
            <option value="Licenciatura Cuatrimestral (CEP/SEP)">Licenciatura Cuatrimestral (CEP/SEP)</option>
            <option value="Bachillerato Intensivo (BIS)">Bachillerato Intensivo (BIS)</option>
            <option value="Bachillerato General (BGC)">Bachillerato General (BGC)</option>
          </select>
        </div>

        <div class="row actions">
          <button id="start" class="btn-accent" type="button">‚ñ∂Ô∏è Iniciar conversaci√≥n</button>
          <button id="reset" class="ghost" type="button">Reiniciar</button>
        </div>

        <hr style="border:none;border-top:1px solid #eef1f5;margin:10px 0">

        <!-- Memoria -->
        <div class="row">
          <label>Memoria de la IA</label>
          <div class="row-inline">
            <span id="memState" class="pill">Memoria: activa</span>
            <label class="hint"><input type="checkbox" id="memEnabled" checked> Aprendizaje continuo</label>
          </div>
          <div class="row-inline">
            <button id="memClear" class="ghost" type="button">üßπ Borrar memoria</button>
            <button id="memExport" class="ghost" type="button">‚§ì Exportar JSON</button>
            <label class="ghost" style="display:inline-flex;align-items:center;gap:8px;padding:8px;border-radius:10px;border:1px solid var(--brand);cursor:pointer">
              ‚§í Importar JSON
              <input id="memImport" type="file" accept="application/json" style="display:none">
            </label>
          </div>
          <div id="memSummary" class="box hint">Sin historial a√∫n.</div>
        </div>

        <hr style="border:none;border-top:1px solid #eef1f5;margin:10px 0">

        <!-- Permisos / Audio -->
        <div class="row">
          <label>Estado de permisos</label>
          <div class="row-inline">
            <span id="permState" class="pill">Micr√≥fono: desconocido</span>
            <button id="askPerm" class="ghost" type="button">üîê Solicitar permiso</button>
            <button id="enableMic" class="ghost" type="button">üîì Habilitar micr√≥fono</button>
            <button id="closeMic" class="ghost" type="button" disabled>‚úñÔ∏è Cerrar micr√≥fono</button>
          </div>
          <div class="hint">Sugerencia: en la barra de direcciones ‚Üí candado ‚Üí Permisos ‚Üí Micr√≥fono: <b>Permitir</b>.</div>
        </div>

        <div class="row">
          <label>Grabaci√≥n (audio)</label>
          <div class="row-inline">
            <button id="recBtn" class="ghost" type="button">üéôÔ∏è Grabar</button>
            <button id="stopBtn" class="ghost" type="button" disabled>‚ñ† Detener</button>
          </div>
          <div class="audio-row">
            <audio id="player" controls></audio>
            <span id="recStatus" class="pill">Micr√≥fono inactivo</span>
          </div>
        </div>

        <div class="row">
          <label>Dictado (transcribir a texto en vivo)</label>
          <div class="row-inline">
            <button id="dictBtn" class="ghost" type="button">üó£Ô∏è Iniciar dictado</button>
            <label class="hint"><input type="checkbox" id="autoRestart" checked> Reintentar autom√°ticamente</label>
            <label class="hint"><input type="checkbox" id="autoSend"> Enviar al terminar</label>
            <span id="sttStatus" class="pill">Dictado: inactivo</span>
          </div>
          <div id="liveBox" class="box hint">Aqu√≠ ver√°s la transcripci√≥n en vivo‚Ä¶</div>
          <div class="hint bad" id="warnBox" style="display:none">Permiso denegado. Cambia a ‚ÄúPermitir‚Äù en el candado del navegador y recarga.</div>
        </div>
        </div>

        <hr style="border:none;border-top:1px solid #eef1f5;margin:10px 0">

        <!-- Modo IA (opcional) -->
        <div class="row">
          <label>Motor de IA (opcional)</label>
          <select id="aiMode">
            <option value="rules">Cliente inteligente (reglas + memoria)</option>
            <option value="api">Proveedor externo (API) ‚Äî beta</option>
          </select>
          <div id="apiBox" class="box hint small" style="display:none">
            Usa tu endpoint propio (por ejemplo, un proxy a OpenAI, Azure, etc.).<br>
            Endpoint <span class="kbd">POST /api/chat</span> (JSON): { messages: [...], memory: {...} } ‚Üí { reply }
            <div class="row-inline" style="margin-top:6px">
              <input id="apiUrl" placeholder="https://tu-servidor/api/chat"/>
              <input id="apiKey" placeholder="API Key (opcional)"/>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Chat -->
    <div class="panel chat">
      <div class="hd">Conversaci√≥n</div>
      <div id="log" class="log"></div>
      <div class="composer">
        <form id="form">
          <textarea id="input" placeholder="Escribe o usa el dictado para pegar aqu√≠ tu respuesta‚Ä¶" disabled></textarea>
          <button id="send" type="submit" disabled>Enviar</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  /* ===== Utilidades comunes ===== */
  function norm(t){return (t||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').replace(/\s+/g,' ').trim();}
  function any(text, arr){ text=norm(text); return arr.some(k=> text.includes(norm(k))); }
  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
  function fmtDate(d){ const x=new Date(d); return x.toLocaleString('es-MX'); }

  /* ===== DOM ===== */
  const logEl = document.getElementById('log');
  const inputEl = document.getElementById('input');
  const sendBtn = document.getElementById('send');
  const startBtn = document.getElementById('start');
  const resetBtn = document.getElementById('reset');
  const scenarioSel = document.getElementById('scenario');
  const aiModeSel = document.getElementById('aiMode');
  const apiBox = document.getElementById('apiBox');
  const apiUrlInp = document.getElementById('apiUrl');
  const apiKeyInp = document.getElementById('apiKey');

  /* ===== Ajustes conversaci√≥n ===== */
  // Ahora el asesor inicia la conversaci√≥n y la IA act√∫a como aspirante.
  const state = {
    phase: 'inicio',
    scenario: 'Licenciatura Semestral UdeG',
    turns: 0
  };

  /* ===== Interfaz chat ===== */
  function addMsg(who, html){
    const row=document.createElement('div'); row.className=`msg ${who}`;
    const av=document.createElement('div'); av.className=`avatar ${who}`; av.textContent=who==='you'? 'As':'CL';
    const b=document.createElement('div'); b.className='bubble'; b.innerHTML=html; row.append(av,b);
    logEl.append(row); logEl.scrollTop=logEl.scrollHeight;
  }
  function enableInput(on){ inputEl.disabled=!on; sendBtn.disabled=!on; if(on) inputEl.focus(); }

  function startSim(resume=false){
    logEl.innerHTML='';
    state.phase='sondeo'; state.asked={ocup:false,factor:false,comparo:false,inicio:false}; state.objectionsUsed=false; state.turns=0;
    state.scenario = scenarioSel.value;

    // Preparar memoria
    if(!resume){ Memory.startSession(state.scenario); }

    // Ahora la conversaci√≥n la inicia el ASESOR (t√∫). El aspirante s√≥lo responde.
    addMsg('ai', 'Listo, estoy conectado como <b>aspirante</b>. T√∫ inicias la conversaci√≥n como asesor.');
    // No registramos una apertura inquisitiva; s√≥lo contexto.
    enableInput(true);
  }

  startBtn.addEventListener('click', ()=>{ startSim(); });
  resetBtn.addEventListener('click', ()=>location.reload());

  document.getElementById('form').addEventListener('submit', (e)=>{
    e.preventDefault();
    const t = (inputEl.value||'').trim(); if(!t) return;
    addMsg('you', t); inputEl.value='';
    respondSmart(t);
  });

  function respondSmart(user){
    // IA responde como ASPIRANTE. Evitar repeticiones y contestar a lo que pregunta el asesor.
    const t = norm(user); state.turns++;

    // Palabras clave ampliadas
    const Q = {
      saludo: ['hola','buen dia','buenos dias','buenas tardes','buenas noches','que tal'],
      ocup: ['trabajas','trabajo','empleo','ocupacion','a que te dedicas','dedicas','laboras','horario'],
      factor: ['que te importa','factor','costo','horario','plan de estudios','empleabilidad','bolsa de trabajo','beca','descuento'],
      comparo: ['comparando','otra universidad','otras opciones','ademas de','has visto otras'],
      inicio: ['cuando quieres iniciar','cuando te gustaria iniciar','proximo ingreso','fecha de inicio','cuando iniciarias','para cuando'],
      costos: ['costos','costo','inscripcion','colegiatura','mensualidad','mensualidades','pagos','pago'],
      becas: ['beca','becas','descuento','apoyos','apoyo economico'],
      instalaciones: ['instalaciones','laboratorios','taller','biblioteca','estacionamiento'],
      cierre: ['agendamos','te paso el link','iniciar inscripcion','inscribirte','agenda','cita','proximo paso','seguimos','te parece']
    };

    // Utilidades de respuesta breve
    const say = (msg)=>{ addMsg('ai', msg); Memory.addTurn('ai', msg, state.phase); };

    // 1) Responder saludos
    if(Q.saludo.some(k=>t.includes(k))){
      say(`¬°Hola! Estoy interesado en <b>${state.scenario}</b>. ¬øMe ayudas con la informaci√≥n?`);
      return;
    }

    // 2) Ocupaci√≥n / horario
    if(Q.ocup.some(k=>t.includes(k))){
      const opciones=[
        'S√≠, trabajo en marketing con horario vespertino. Busco algo que me permita estudiar por las tardes.',
        'Actualmente laboro tiempo completo de 9 a 6; me servir√≠a una opci√≥n con horarios flexibles.',
        'Estoy trabajando medio tiempo y podr√≠a acomodarme por las ma√±anas.'
      ];
      const msg=pick(opciones); say(msg);
      state.asked.ocup=true; Memory.extractFacts('you', msg); // guardar como si fuera hecho del aspirante
      return;
    }

    // 3) Factor de decisi√≥n
    if(Q.factor.some(k=>t.includes(k))){
      const opciones=[
        'Para m√≠ lo principal es el <b>horario</b> y que sea compatible con el trabajo.',
        'Lo m√°s importante es el <b>costo</b> y si hay <b>beca</b>.',
        'Me fijo en el <b>plan de estudios</b> y la proyecci√≥n laboral.'
      ];
      const msg=pick(opciones); say(msg); state.asked.factor=true; Memory.extractFacts('you', msg); return;
    }

    // 4) Comparaci√≥n
    if(Q.comparo.some(k=>t.includes(k))){
      const msg=pick([
        'S√≠, he visto un par de opciones pero quiero entender bien qu√© ofrece UTEG.',
        'Estoy comparando, pero me interesa que me orienten para decidir mejor.'
      ]); say(msg); state.asked.comparo=true; return; }

    // 5) Inicio deseado
    if(Q.inicio.some(k=>t.includes(k))){
      const msg=pick([
        'Si todo encaja, me gustar√≠a iniciar en el pr√≥ximo ingreso.',
        'Podr√≠a comenzar en cuanto se abra el siguiente ciclo.'
      ]); say(msg); state.asked.inicio=true; Memory.extractFacts('you', msg); return; }

    // 6) Si el asesor pregunta por instalaciones/costos/becas, el aspirante no da detalles; pide confirmaci√≥n o m√°s info breve
    if(Q.instalaciones.some(k=>t.includes(k))){ say('Me interesa saber si cuentan con laboratorios y biblioteca.'); return; }
    if(Q.costos.some(k=>t.includes(k))){ say('¬øMe podr√≠as indicar inscripci√≥n y colegiaturas? Tambi√©n si manejan pronto pago.'); return; }
    if(Q.becas.some(k=>t.includes(k))){ say('¬øHay convocatorias de beca o descuentos vigentes?'); return; }

    // 7) Cierre
    if(Q.cierre.some(k=>t.includes(k))){
      const afirmar = Math.random()<0.6;
      if(afirmar){
        const msg=pick(['S√≠, me parece bien. ¬øPodemos agendar la cita?','De acuerdo, comp√°rteme el link para iniciar el registro.']);
        say(msg); Memory.endSession('closed-won'); Memory.data.counters.closes++; enableInput(false); return;
      } else {
        say('A√∫n quiero revisar un par de cosas. Si quieres, te comparto datos de conocidos interesados.');
        Memory.endSession('referrals'); enableInput(false); return;
      }
    }

    // 8) Por defecto: confirmar recepci√≥n sin repetir
    say('Perfecto, te escucho.');
  }

  /* ===== Dictado ===== */
  const dictBtn=document.getElementById('dictBtn');
  const autoRestart=document.getElementById('autoRestart');
  const sttStatus=document.getElementById('sttStatus');
  const autoSend=document.getElementById('autoSend');
  const liveBox=document.getElementById('liveBox');
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition || null;
  let stt=null, sttOn=false, sttWantsOn=false;
  function initStt(){ if(!SpeechRecognition){ alert('Tu navegador no soporta dictado.'); return null; } const r=new SpeechRecognition(); r.lang='es-MX'; r.interimResults=true; r.continuous=true; r.onstart=()=>{ sttOn=true; sttStatus.textContent='Dictado: activo'; dictBtn.textContent='‚ñ† Detener dictado'; };
    r.onresult=(ev)=>{ let final="", interim=""; for(let i=0;i<ev.results.length;i++){ const res=ev.results[i]; const txt=res[0].transcript.trim(); if(res.isFinal){ final=(final+" "+txt).trim(); } else { interim=(interim+" "+txt).trim(); } } const full=(final+" "+interim).trim(); liveBox.textContent=full||'‚Ä¶'; inputEl.value=full; enableInput(true); };
    r.onerror=(e)=>{ sttOn=false; sttStatus.textContent='Dictado: error'; if(sttWantsOn && autoRestart.checked){ try{ r.start(); }catch(_){} } };
    r.onend=()=>{ sttOn=false; sttStatus.textContent='Dictado: inactivo'; lastResultIndex=0; if(permDenied || lastPermState==='denied'){ sttWantsOn=false; return; } if(sttWantsOn && autoRestart.checked){ try{ r.start(); }catch(_){} } else {
      // Si se detuvo y est√° activado autoSend, enviar el texto actual
      const val=(inputEl.value||'').trim(); if(autoSend && autoSend.checked && val){ document.getElementById('form').dispatchEvent(new Event('submit')); }
    } };
    return r; }
  dictBtn.addEventListener('click', ()=>{ if(!stt){ stt=initStt(); if(!stt) return; } if(!sttWantsOn){ sttWantsOn=true; try{ if(!sttOn) stt.start(); }catch(_){} } else { sttWantsOn=false; try{ if(sttOn) stt.stop();
